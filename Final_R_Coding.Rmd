---
title: "Covid-19 Dashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    source_code: embed
    theme: journal
---

```{r setup, include=FALSE}
library(flexdashboard)
```

```{r, include=FALSE}
# EDA AND DATA MANIPULATION

# Loading necessary paclages to R
library(dplyr)

library(tidyverse)

# Loading the Covid 19 global data 
covid_19_data <- read.csv("WHO-COVID-19-global-data.csv")

# Checking for NA values in the entire dataframe
na_summary <- sapply(covid_19_data, function(col) sum(is.na(col)))

# Display the summary of NA values
print(na_summary) # No NA values were found to disrupt data 

# Case Counts
# Selecting the important columns for Covid 19 case count 
covid_19_data_cases <- covid_19_data %>%
  select(Date_reported, Country_code, Country, New_cases, Cumulative_cases)

# Keeping latest data regarding cumulative cases from each Country for the year 2022 (December.31.2022)
covid_19_data_latest_cases <- covid_19_data %>%
  select(Date_reported, Country_code, Country, Cumulative_cases)

covid_19_data_latest_cases <- covid_19_data_latest_cases %>%
  filter(Date_reported == "2022-12-31")

# Death Counts
# Selecting the important columns for Covid 19 death count 
covid_19_data_deaths <- covid_19_data %>%
  select(Date_reported, Country_code, Country, New_deaths, Cumulative_deaths)

# Keeping latest data regarding cumulative deaths from each Country for the year 2022 (December.31.2022)
covid_19_data_latest_deaths <- covid_19_data %>%
  select(Date_reported, Country_code, Country, Cumulative_deaths)

covid_19_data_latest_deaths <- covid_19_data_latest_deaths %>%
  filter(Date_reported == "2022-12-31")

# Loading the necessary packages for API search
library(wbstats)

# Viewing the data set generated from the wbstats package regarding Country information
  # We can view the average income per Country by looking at the "country" column and the "income_level" column.
View(wb_countries())

# Viewing the GDP data for each Country 
df_gdp <- wb_data("NY.GDP.MKTP.CD")

filtered_df_gdp <- df_gdp %>%
  filter(date %in% c(2020, 2021, 2022))

# Viewing the unemployment levels per Country
df_unemployment <- wb_data("SL.UEM.TOTL.ZS")

filtered_df_unemployment <- df_unemployment %>%
  filter(date %in% c(2022))

# Viewing the population data for each Country 
df_population <- wb_data("SP.POP.TOTL")

filtered_df_population <- df_population %>%
  filter(date %in% c(2022))
```

```{r, include=FALSE}

# CALCULATIONS

# Calculating Prevalence (Confirmed cases by Population)
  # Looking at the "covid_19_data_latest_cases" data frame and "filtered_df_population"data frame
prevalence <- covid_19_data_latest_cases %>%
  left_join(filtered_df_population, 
            by = c("Country_code" = "iso2c")) %>%
  select(-iso3c:-date,-unit:-last_updated) %>%
  mutate(prevalence_covid = (Cumulative_cases / SP.POP.TOTL))
View(prevalence)

# Case Fatality Rate (Deaths per Infected Population)
# Selecting the important columns for Covid 19 Population Count 
covid_19_data_cases_fatality <- covid_19_data %>%
  select(Date_reported, Country_code, Country, Cumulative_cases, Cumulative_deaths)

covid_19_data_cases_fatality <- covid_19_data_cases_fatality %>%
  filter(Date_reported == "2022-12-31")

covid_19_data_cases_fatality <- covid_19_data_cases_fatality %>%
  mutate(Case_Fatality_Rate = Cumulative_deaths / Cumulative_cases)

# Mortality Rate (Deaths per Total Population)
# Looking at the "covid_19_data_latest_deaths" data frame and "filtered_df_population"data frame

mortality_rate_per_country <- covid_19_data_latest_deaths %>%
  left_join(filtered_df_population, 
            by = c("Country_code" = "iso2c")) %>%
  select(-iso3c:-date,-unit:-last_updated) %>%
  mutate(Mortality_rate = (Cumulative_deaths / SP.POP.TOTL))

  
```

# Demographics

## Row {data-height="100"}

Covid- 19 data from Jan 1, 2020 and Dec 31, 2022 was reported below in each country as reported by the World Health Organization (WHO).

### Interactive World Map

```{r}
# Load necessary libraries
library(flexdashboard)
library(leaflet)
library(maps)
library(maptools)
library(dplyr)
library(sf)
library(countrycode)

# Get the world map
world_map <- map("world", fill = TRUE, plot = FALSE)
world <- st_as_sf(map2SpatialPolygons(world_map, IDs = world_map$names, proj4string = CRS("+proj=longlat +datum=WGS84")))

# Example filtered_df_population data (replace with your actual data)
filtered_df_population <- data.frame(
  iso2c = c("US", "FR"),
  stat1 = c(100, 200),
  stat2 = c(300, 400),
  stat3 = c(500, 600)
)

# Convert country names to iso2c codes
iso2c_codes <- countrycode::countrycode(world_map$names, 'country.name', 'iso2c')

# Create a dataframe with spatial data
world_data <- data.frame(
  iso2c = iso2c_codes,
  geometry = world$geometry
)

# Merge your data with the spatial data
world <- world_data %>%
  left_join(filtered_df_population, by = "iso2c") %>%
  st_as_sf()

# Create the map and add the hover functionality
leaflet(world) %>%
  addTiles() %>%
  addPolygons(
    fillColor = "blue", # Simple color for illustration
    popup = ~paste("Stat1:", stat1, "<br>",
                   "Stat2:", stat2, "<br>",
                   "Stat3:", stat3)
  )



```

# Covid + Socioeconomic Factors

## Row {data-height="100"}

SE Indicators ..................

### Chart 1

```{r}
library(ggplot2)

ggplot(covid_19_data, aes(x = WHO_region, y = Cumulative_cases, fill = WHO_region)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Case Fatality Rate by WHO Region",
       x = "WHO Region",
       y = "Case Fatality Rate") +
  theme_minimal() +
  scale_fill_discrete(name = "WHO_region")

```


### Case fatality by GDP

```{r}

gdp_22 <- df_gdp %>% 
  filter(date == 2022)
View(gdp_22)

gdp_22 <- gdp_22 %>%
  rename(Country = country)

merge_gdp_cfr <- merge(gdp_22, covid_19_data_cases_fatality, by = "Country", all.x = TRUE)

View(merge_gdp_cfr)

library(ggplot2)

ggplot(merge_gdp_cfr, aes(x= NY.GDP.MKTP.CD, y = log(Case_Fatality_Rate))) +
  geom_point() +
  labs(title = "Case Fatality Rate according to GDP",
       x = "GDP",
       Y = "Case Fatality Rate") + 
  scale_x_continuous(limits = c(min(merge_gdp_cfr$NY.GDP.MKTP.CD), max(merge_gdp_cfr$NY.GDP.MKTP.CD)))

```

### Case Fatality by Income

```{r}

gdp_22 <- df_gdp %>% 
  filter(date == 2022)
View(gdp_22)

pop_22 <- df_population %>%
  filter(date == 2022)
View(pop_22)

pop_22 <- pop_22 %>%
  rename(Country_code = iso2c)

merge_pop22_cfr <- merge(pop_22, covid_19_data_cases_fatality, by = "Country_code", all.x = TRUE)

View(merge_pop22_cfr)

merge_pop22_cfr <- merge_pop22_cfr %>%
  rename(iso2c = Country_code)

merge_pop22_cfr_income <- merge(merge_pop22_cfr, wb_countries(), by = "iso2c", all.x = TRUE)

View(merge_pop22_cfr_income)

library(ggplot2)

merge_pop22_cfr_income$income_level <-as.factor(merge_pop22_cfr_income$income_level)


ggplot(merge_pop22_cfr_income, aes(x = income_level, y= Case_Fatality_Rate)) +
  geom_boxplot(fill = "lightgrey") + 
  labs(title = "Case Fatality by Income Level",
       x= "Income Level",
       y = "Case Fatality Rate")
  
```

### Case fatality by Unemployment Rate

```{r}

unemployment_22 <- df_unemployment %>% 
  filter(date == 2022)
View(unemployment_22)

unemployment_22 <- unemployment_22 %>%
  rename(Country = country)

merge_unemployment_cfr <- merge(unemployment_22, covid_19_data_cases_fatality, by = "Country", all.x = TRUE)

View(merge_unemployment_cfr)

library(ggplot2)

ggplot(merge_unemployment_cfr, aes(x= SL.UEM.TOTL.ZS, y = log(Case_Fatality_Rate))) +
  geom_point() +
  labs(title = "Case Fatality Rate according to Unemployment Rate",
       x = "Unemployment Rate",
       Y = "Case Fatality Rate") + 
  scale_x_continuous(limits = c(min(merge_unemployment_cfr$SL.UEM.TOTL.ZS), max(merge_unemployment_cfr$SL.UEM.TOTL.ZS)))

```


### Case fatality by Unemployment Rate

```{r}

unemployment_22 <- df_unemployment %>% 
  filter(date == 2022)
View(unemployment_22)

unemployment_22 <- unemployment_22 %>%
  rename(Country = country)

merge_unemployment_cfr <- merge(unemployment_22, covid_19_data_cases_fatality, by = "Country", all.x = TRUE)

View(merge_unemployment_cfr)

library(ggplot2)

ggplot(merge_unemployment_cfr, aes(x= SL.UEM.TOTL.ZS, y = log(Case_Fatality_Rate))) +
  geom_point() +
  labs(title = "Case Fatality Rate according to Unemployment Rate",
       x = "Unemployment Rate",
       Y = "Case Fatality Rate") + 
  scale_x_continuous(limits = c(min(merge_unemployment_cfr$SL.UEM.TOTL.ZS), max(merge_unemployment_cfr$SL.UEM.TOTL.ZS)))

```





``` {r, include = FALSE}

library(dplyr)
merge_unemployment_cfr <- merge_unemployment_cfr%>%
mutate(SL.UEM.TOTL.ZS = case_when(
  SL.UEM.TOTL.ZS > 0 & SL.UEM.TOTL.ZS <= 10 ~ 1,
  SL.UEM.TOTL.ZS > 10 & SL.UEM.TOTL.ZS <= 20 ~ 2,
  SL.UEM.TOTL.ZS > 20 & SL.UEM.TOTL.ZS <= 30 ~3,
         TRUE ~ NA_integer_
  ))

levels(merge_unemployment_cfr$SL.UEM.TOTL.ZS)
merge_unemployment_cfr$SL.UEM.TOTL.ZS <- as.factor(merge_unemployment_cfr$SL.UEM.TOTL.ZS)

levels(merge_unemployment_cfr$Country)
merge_unemployment_cfr$Country <- as.factor(merge_unemployment_cfr$Country)


View(merge_unemployment_cfr)
merge_unemployment_cfr <- merge_unemployment_cfr %>%
  rename(unemploy_rate = SL.UEM.TOTL.ZS)

anova(lm(Case_Fatality_Rate ~ unemploy_rate, data = merge_unemployment_cfr))

```


